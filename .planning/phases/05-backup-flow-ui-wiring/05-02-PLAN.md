---
phase: 05-backup-flow-ui-wiring
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified: [components/setting-modal/setting-modal.vue]
autonomous: false

must_haves:
  truths:
    - "User can import backup JSON from UI; invalid/malformed data shows clear error without DB corruption"
    - "UI feedback reflects importBackupData result (success/error)"
  artifacts:
    - path: components/setting-modal/setting-modal.vue
      provides: "Import NUpload + inline feedback"
      contains: "importBackupData"
  key_links:
    - from: components/setting-modal/setting-modal.vue
      to: utils/backup.ts
      via: "import importBackupData, ImportBackupResult type"
      pattern: "importBackupData"
    - from: components/setting-modal/setting-modal.vue
      to: components/upload/upload.vue
      via: "NUpload with accept .json, @pick handler"
      pattern: "n-upload"
---

<objective>
Wire backup import to setting-modal with NUpload, loading state, and inline success/error feedback; verify E2E backup flow.

Purpose: BKUP-02 — import UI with schema validation feedback; importBackupData returns { success, error? } for UI display.
Output: Import button + file picker in backup section; inline feedback using --color-success / --color-danger.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-backup-flow-ui-wiring/05-RESEARCH.md
@utils/backup.ts
@components/setting-modal/setting-modal.vue
@components/upload/upload.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import NUpload, handler, and inline feedback</name>
  <files>components/setting-modal/setting-modal.vue</files>
  <action>
Add import UI to the backup section (created in 05-01).

1. Import NUpload from '@/components/upload', importBackupData and ImportBackupResult from '@/utils/backup'

2. Add refs:
   - importResult: ref&lt;ImportBackupResult | null&gt;(null)
   - importing: ref(false)

3. Add handleImport(file: File) async:
   - Set importResult.value = null at start (clear stale result per RESEARCH Pitfall 2)
   - Set importing.value = true
   - try { importResult.value = await importBackupData(file) } finally { importing.value = false }

4. Add NUpload in backup-actions (next to export button):
   - accept=".json,application/json"
   - :disabled="importing"
   - @pick="handleImport"
   - Slot: n-button variant="secondary" :loading="importing" — "选择备份文件" or "导入备份"

5. Add inline feedback div below buttons:
   - v-if="importResult"
   - :class="importResult.success ? 'import-success' : 'import-error'"
   - Text: importResult.success ? '导入成功' : importResult.error

6. Add styles:
   - .import-success { color: var(--color-success); font-size: var(--text-caption); }
   - .import-error { color: var(--color-danger); font-size: var(--text-caption); }
</action>
  <verify>npm run dev:web; open settings; import valid backup JSON — success message shows; import invalid JSON (e.g. plain text) — error message shows; DB not corrupted</verify>
  <done>Import shows success/error inline; importing state disables button; invalid data never writes to DB</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify E2E backup flow</name>
  <files>N/A (human verification)</files>
  <action>Human follows how-to-verify steps to confirm export/import flow works end-to-end</action>
  <verify>User completes steps 1–6 in how-to-verify; types "approved" or reports issues</verify>
  <done>E2E backup flow verified: export downloads, import restores, invalid data shows error</done>
  <what-built>Complete backup export/import flow: export button, import file picker, success/error feedback</what-built>
  <how-to-verify>
    1. Open new tab, open settings modal
    2. Click "导出备份" — JSON file downloads with gridItems and gridOrder
    3. Add/remove a site or change layout
    4. Click "选择备份文件" / "导入备份", select the exported JSON
    5. Verify "导入成功" appears; page layout/sites match exported state
    6. Import invalid file (e.g. .txt with junk) — verify error message, DB unchanged
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Import button visible; file picker restricts to .json
- Valid import shows "导入成功" in green
- Invalid import shows error message in red; IndexedDB unchanged
- Loading state disables button during import
</verification>

<success_criteria>
[ ] User can import backup from UI
[ ] Invalid/malformed data shows clear error, no DB corruption
[ ] UI displays importBackupData result (success or error)
</success_criteria>

<output>
After completion, create `.planning/phases/05-backup-flow-ui-wiring/05-02-SUMMARY.md`
</output>
