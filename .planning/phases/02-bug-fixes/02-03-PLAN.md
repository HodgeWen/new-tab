---
phase: 02-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - utils/wallpaper-providers.ts
autonomous: true

must_haves:
  truths:
    - 'Wallpaper loads in dev:web mode without CORS errors'
  artifacts:
    - path: vite.config.ts
      provides: 'server.proxy for /api/picsum and /api/bing'
      contains: 'proxy'
    - path: utils/wallpaper-providers.ts
      provides: 'Proxy base URLs when isDevWeb'
      contains: 'isDevWeb'
  key_links:
    - from: utils/wallpaper-providers.ts
      to: vite proxy
      via: 'fetch /api/picsum and /api/bing when isDevWeb'
      pattern: 'api/(picsum|bing)'
    - from: vite.config.ts
      to: external APIs
      via: 'proxy rewrite strips /api/* prefix'
      pattern: "path\\.replace.*api/(picsum|bing)"
---

<objective>
Add Vite proxy for Bing/Picsum wallpaper APIs (BUGF-04).

Purpose: In dev:web, fetches to bing.com and picsum.photos trigger CORS. Vite server.proxy bypasses CORS by proxying through same-origin. Extension mode uses host_permissions and is unaffected.
Output: vite.config.ts with proxy; wallpaper-providers.ts using proxy URLs when isDevWeb.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes/02-RESEARCH.md
@vite.config.ts
@utils/wallpaper-providers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Vite proxy config</name>
  <files>vite.config.ts</files>
  <action>
Add `server.proxy` to the existing `server` object in vite.config.ts:
```ts
server: {
  port: 5173,
  open: false,
  proxy: {
    '/api/picsum': {
      target: 'https://picsum.photos',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/picsum/, ''),
    },
    '/api/bing': {
      target: 'https://www.bing.com',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/bing/, ''),
    },
  },
},
```
Note: `npm run dev:web` uses root vite.config.ts (vite CLI); wxt.config.ts vite callback is for extension build.
  </action>
  <verify>
- vite.config.ts has proxy entries for /api/picsum and /api/bing
- rewrite strips prefix so target receives correct path (e.g. /HPImageArchive.aspx for Bing)
  </verify>
  <done>Vite proxy configured for Picsum and Bing APIs</done>
</task>

<task type="auto">
  <name>Task 2: Use proxy URLs in wallpaper-providers when isDevWeb</name>
  <files>utils/wallpaper-providers.ts</files>
  <action>
1. Add isDevWeb detection at top of file (after imports):
   `const isDevWeb = import.meta.env.DEV && !window.location.href.startsWith('chrome-extension://')`
2. Define API_BASE: when isDevWeb use `/api/picsum` and `/api/bing`; otherwise use `https://picsum.photos` and `https://www.bing.com`
3. Replace hardcoded URLs in:
   - fetchPicsumList: `{picsum}/v2/list`
   - BingWallpaperProvider: `{bing}/HPImageArchive.aspx`, baseUrl for image URLs
   - PicsumPhotosWallpaperProvider: `{picsum}/id/{id}/1920/1080`, thumbUrl, downloadUrl
Ensure extension mode (chrome-extension://) and production always use real URLs â€” proxy only in dev:web.
  </action>
  <verify>
- Run `npm run dev:web`, open http://localhost:5173, select Bing or Picsum wallpaper; wallpaper loads without CORS error
- Network tab shows requests to /api/picsum or /api/bing (proxied), not direct bing.com/picsum.photos
- Extension build (`npm run build`) still fetches directly (no proxy in prod)
  </verify>
  <done>Wallpaper loads in dev:web without CORS; extension mode unchanged</done>
</task>

</tasks>

<verification>
- dev:web wallpaper loads without CORS
- Proxy rewrite correct; extension/prod uses real URLs
</verification>

<success_criteria>
BUGF-04 resolved: Wallpaper loads in dev:web mode without CORS errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes/02-03-SUMMARY.md`
</output>
