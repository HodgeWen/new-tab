---
phase: 01-policy-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/site-modal/site-modal.vue
autonomous: true
must_haves:
  truths:
    - "User cannot add site shortcuts with javascript: or other dangerous URL schemes—invalid schemes are rejected"
  artifacts:
    - path: components/site-modal/site-modal.vue
      provides: "URL scheme validation (http/https only)"
      contains: "normalizeAndValidate"
  key_links:
    - from: components/site-modal/site-modal.vue
      to: urlStatus
      via: normalizeAndValidate used in urlStatus computed
      pattern: "urlStatus.*normalizeAndValidate"
    - from: components/site-modal/site-modal.vue
      to: handleSave
      via: validate before save, reject if invalid
      pattern: "handleSave.*normalizeAndValidate"
---

<objective>
Add URL scheme allow-list validation for site shortcuts so only http: and https: protocols are accepted, blocking javascript:, data:, and other dangerous schemes (PLCY-02).

Purpose: Malicious URLs in href can execute script or navigate unexpectedly; allow-list prevents XSS and policy violations.
Output: Modified site-modal.vue with normalizeAndValidate; urlStatus and handleSave reject invalid schemes.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-policy-compliance/01-RESEARCH.md
@components/site-modal/site-modal.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add normalizeAndValidate and wire to urlStatus</name>
  <files>components/site-modal/site-modal.vue</files>
  <action>
Add normalizeAndValidate(urlString: string): string | null per RESEARCH Pattern 2:

1. Parse raw input first with `new URL(trimmed)` — if it throws, try `new URL('https://' + trimmed)`.
2. Check protocol: only allow `parsed.protocol === 'http:' || parsed.protocol === 'https:'`.
3. Return parsed.href if allowed, else null.

Replace urlStatus computed: use `normalizeAndValidate(form.url.trim())` instead of `parseUrl(normalizeUrl(url))`. Return 'error' when result is null and url non-empty, 'success' when non-null.

CRITICAL: Do NOT normalize before protocol check. "javascript:alert(1)" must be rejected because parsed.protocol is "javascript:" — never add https:// prefix before checking protocol.
  </action>
  <verify>
1. Add site with "javascript:alert(1)" → urlStatus shows error, Save disabled.
2. Add site with "https://example.com" → urlStatus success, Save enabled.
3. Add site with "example.com" (no scheme) → urlStatus success (https:// added), Save enabled.
  </verify>
  <done>
javascript: and data: URLs show error state; http/https URLs pass validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update handleUrlChange and handleSave to use normalizeAndValidate</name>
  <files>components/site-modal/site-modal.vue</files>
  <action>
1. handleUrlChange: Replace `normalizeUrl` with `normalizeAndValidate`. If result is null, do not auto-fill form.url or fetch favicon. Only proceed with parsing/normalization when validate returns non-null.

2. handleSave: At start, call `const validatedUrl = normalizeAndValidate(form.url.trim())`. If null, return early (do not save). Use validatedUrl when constructing the item to save (it is the canonical safe URL).

Ensure handleSave cannot save when urlStatus is 'error' — canSave already gates this, but add explicit validate-and-reject at save time for defense in depth.
  </action>
  <verify>
1. Enter "javascript:alert(1)", try to save (if canSave were bypassed) → no save occurs.
2. Enter "https://example.com", save → site created with correct URL.
3. handleUrlChange with "data:text/html,test" → no auto-fill, urlStatus error.
  </verify>
  <done>
handleUrlChange and handleSave both use normalizeAndValidate; invalid URLs never reach the store.
  </done>
</task>

</tasks>

<verification>
- javascript:alert(1) → rejected (urlStatus error, cannot save)
- data: URLs → rejected
- http:// and https:// URLs → accepted
- Bare domains (example.com) → normalized to https:// and accepted
- No blacklist approach; allow-list only (http:, https:)
</verification>

<success_criteria>
PLCY-02 satisfied: Site shortcuts accept only http: and https: URLs; malicious schemes are rejected at add/edit.
</success_criteria>

<output>
After completion, create `.planning/phases/01-policy-compliance/01-02-SUMMARY.md`
</output>
