---
phase: 03-backup-data-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/backup.ts
  - types/db.ts
autonomous: true

must_haves:
  truths:
    - "Exported backup file contains grid layout/order"
    - "Import restores gridOrder to localStorage (restore preserves arrangement)"
  artifacts:
    - path: utils/backup.ts
      provides: "exportBackupData includes gridOrder; importBackupData restores gridOrder"
      min_lines: 55
    - path: store/grid-order.ts
      provides: "gridOrder ref and updateGridOrder for dual-source export"
  key_links:
    - from: utils/backup.ts
      to: store/grid-order.ts
      via: "import gridOrder for export, updateGridOrder for import"
      pattern: "gridOrder|updateGridOrder"
---

<objective>
Include grid order in backup export and restore it on import (BKUP-01).

Purpose: Backup currently exports only gridItems from IndexedDB; grid order lives in localStorage (store/grid-order.ts) and is omitted. Restore loses custom layout. Per STATE.md: "存储保持双轨 — 本次不迁移，BKUP-01 从 localStorage 读取 grid order 导出".
Output: Backup JSON contains { gridItems, gridOrder }; import restores both to IndexedDB and localStorage.
</objective>

<execution_context>
@/home/whj/.claude/get-shit-done/workflows/execute-plan.md
@/home/whj/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backup-data-integrity/03-RESEARCH.md
@utils/backup.ts
@store/grid-order.ts
@store/grid-items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend export to include gridOrder from store</name>
  <files>utils/backup.ts</files>
  <action>
In exportBackupData, read gridOrder from store (gridOrder.value) and include in backup JSON. Per RESEARCH Pattern 1 (Dual-Source Export):
1. Import `gridOrder` from `@/store/grid-order`
2. Change `const data = { gridItems }` to `const data = { gridItems, gridOrder: gridOrder.value }`
3. Keep JSON.stringify(data, null, 2) and saveFile unchanged

Ensure gridOrder is always included (even if empty array). Do NOT migrate gridOrder to IndexedDB—read from store only.
  </action>
  <verify>
- Call exportBackupData; downloaded JSON file contains top-level "gridOrder" key
- gridOrder value matches current localStorage "grid-order" content
  </verify>
  <done>Exported backup file contains gridOrder key with ID array</done>
</task>

<task type="auto">
  <name>Task 2: Extend import to restore gridOrder and reload grid</name>
  <files>utils/backup.ts, store/grid-items.ts</files>
  <action>
In importBackupData, after bulkAdd succeeds, restore gridOrder and refresh grid state:
1. Import `updateGridOrder` from `@/store/grid-order`, `loadGridItems` from `@/store/grid-items`
2. After `await db.gridItems.bulkAdd(data.gridItems)`:
   - If `data.gridOrder` exists and is non-empty array: `updateGridOrder(data.gridOrder)`
   - Else (backward compat for old backups): `updateGridOrder(data.gridItems.map(i => i.id))`
3. Call `await loadGridItems()` to refresh store from DB (per RESEARCH Pitfall 1: UI must reflect new order)

Keep existing try/catch; return false on any error. Type assertion `as BackupData` remains for now (schema validation is 03-02).

Note: types/db.ts BackupData interface may need `gridOrder?: string[]` added for type safety. Add if present structure lacks it.
  </action>
  <verify>
- Import backup with gridOrder key; after import, localStorage "grid-order" matches backup
- Import backup without gridOrder (legacy); order derives from gridItems
- npm run build succeeds
  </verify>
  <done>Import restores gridOrder to localStorage; loadGridItems refreshes UI state</done>
</task>

</tasks>

<verification>
- Exported backup contains gridOrder
- Import restores gridOrder; legacy backups without gridOrder derive order from gridItems
- Build passes
</verification>

<success_criteria>
BKUP-01 satisfied: Backup export includes grid layout/order; restore preserves arrangement
</success_criteria>

<output>
After completion, create `.planning/phases/03-backup-data-integrity/03-01-SUMMARY.md`
</output>
