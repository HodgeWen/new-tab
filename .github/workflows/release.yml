name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Chrome extension
        run: bun run build

      - name: Build Firefox extension
        run: bun run build:firefox

      - name: Create Chrome zip
        run: bun run zip

      - name: Create Firefox zip
        run: bun run zip:firefox

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          # ä» CHANGELOG.md ä¸­æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
          VERSION="${{ steps.version.outputs.VERSION }}"
          # ä½¿ç”¨ awk æå–å¯¹åº”ç‰ˆæœ¬çš„ section
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" ver "\\]") found=1
              next
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´å†…å®¹ã€‚"
          fi

          # è®¾ç½®å¤šè¡Œè¾“å‡º
          echo "CONTENT<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: List output files
        run: ls -la .output/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body: |
            ## New Tab Extension v${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CONTENT }}

            ---

            ### ğŸ“¦ å®‰è£…è¯´æ˜

            #### Chrome / Edge / Brave
            1. ä¸‹è½½ `new-tab-${{ steps.version.outputs.VERSION }}-chrome.zip`
            2. æ‰“å¼€æµè§ˆå™¨æ‰©å±•é¡µé¢ (`chrome://extensions`)
            3. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
            4. å°† zip æ–‡ä»¶è§£å‹åï¼Œç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"é€‰æ‹©è§£å‹ç›®å½•

            #### Firefox
            1. ä¸‹è½½ `new-tab-${{ steps.version.outputs.VERSION }}-firefox.zip`
            2. æ‰“å¼€ `about:debugging#/runtime/this-firefox`
            3. ç‚¹å‡»"ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
            4. é€‰æ‹© zip æ–‡ä»¶ä¸­çš„ manifest.json
          files: .output/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
